# Usage of the drivers

Here a brief tutorial to use the libraries in other projects and configure correctly:

## Driver Structure

```
my_project/

‚îú‚îÄ‚îÄ CMakeLists.txt                      # main CMake file of the project 

‚îú‚îÄ‚îÄ sdkconfig                           # Configuration generated by `menuconfig`

‚îú‚îÄ‚îÄ main/

‚îÇ   ‚îú‚îÄ‚îÄ CMakeLists.txt                  # project Cmake file.

‚îÇ   ‚îú‚îÄ‚îÄ main.c                          # main file of the project

‚îî‚îÄ‚îÄ sensor_driver/                      # driver folder

    ‚îú‚îÄ‚îÄ sensor_driver.c                 # Iimplementation of the folder

    ‚îî‚îÄ‚îÄ include/                        # header files folder
        
        ‚îú‚îÄ‚îÄ sensor_driver.h             # header file
        
        ‚îî‚îÄ‚îÄ driver_config.h             # optional configuration of the driver
    

```

## Basic configuration of the `main/CMakeLists.txt`

The following code shows how to corretly configure the CMakeLists file for the proper use of the structure of the drivers presented previously


```c
file (GLOB SRC_FILES "../sensor_driver/*.c")

idf_component_register(
        SRCS "main.c" ${SRC_FILES}
        INCLUDE_DIRS "." "../sensor_driver/include"
)

``` 
---

## üìå Table of Contents  
- [Overview](#overview)  
- [Key Hardware Peripherals](#key-hardware-peripherals)  
  - [Encoder: AS5600](#encoder-as5600)  
  - [Speed Controller: HobbyWing SkyWalker 60A](#speed-controller-hobbywing-skywalker-60a)  
  - [IMU: TransducerM TM151 (9-axis AHRS)](#imu-transducerm-tm151-9-axis-ahrs)  
---

## Overview  
This firmware implements the core functionality of the SEA Striker robot: sensor acquisition (encoders, IMU), actuator control (BLDC motors via ESCs), motion control (PID loops), and communications (UDP, WiFi). The architecture is modular and designed for concurrency under FreeRTOS on the ESP32 S3. The code is organized in libraries to abstract platform-specific peripherals (I¬≤C, ADC, PWM, GPIO) and individual device drivers, plus higher-level control and task scheduling.  

---

## Key Hardware Peripherals  

### Encoder: AS5600  
| Parameter | Specification |
|-----------|-------------|
| Device | AS5600 ‚Äì 12-bit programmable contactless magnetic rotary position sensor. :contentReference[oaicite:1]{index=1} |
| Output modes | 12-bit analog voltage or PWM or I¬≤C raw angle. :contentReference[oaicite:2]{index=2} |
| Angular resolution | 12-bit ‚Üí 4096 positions/rotation. :contentReference[oaicite:3]{index=3} |
| Supply voltage | 3.3 V or 5 V compatible. :contentReference[oaicite:4]{index=4} |
| Operating temperature | ‚Äì40 ¬∞C to +125 ¬∞C. :contentReference[oaicite:5]{index=5} |
| Interface | I¬≤C (address 0x36 default) plus optional PWM/Analog. :contentReference[oaicite:6]{index=6} |
| Key features | Contactless measurement, no mechanical wear, programmable start/stop angle, direction pin (DIR) controls increasing or decreasing angle. :contentReference[oaicite:7]{index=7} |

**Usage in this project**: Configured for analog output mode (for this robot). Hist√©resis set to 2 LSB to avoid jitter when the wheel is stationary. Output analog range from 10% to 90% of VCC.  

---

### Speed Controller: HobbyWing SkyWalker 60A  
| Parameter | Specification |
|-----------|-------------|
| Device | SkyWalker 60A ESC ‚Äì Brushless motor speed controller. :contentReference[oaicite:9]{index=9} |
| Continuous current | 60 A (burst up to ~80 A for short periods) for the 60A UBEC variant. :contentReference[oaicite:10]{index=10} |
| Input voltage (battery) | 2‚Äì6 S LiPo (for 60A UBEC version) or 3‚Äì6S depending on variant. :contentReference[oaicite:11]{index=11} |
| BEC output | Switch-mode 5 V @ 5 A (UBEC version). :contentReference[oaicite:12]{index=12} |
| Max motor RPM (2-pole motor) | Up to ~210 000 rpm (2-pole) depending on variant. :contentReference[oaicite:13]{index=13} |
| Dimensions / Weight | Approximately 77 √ó 35 √ó 14 mm, ~63 g (for 60A UBEC). :contentReference[oaicite:14]{index=14} |
| Features | Advanced MCU (32-bit) for motor control, multiple protections (low voltage, thermal, throttle signal loss), programmable via transmitter/LED box. :contentReference[oaicite:15]{index=15} |

**Usage in this project**: Two speed controllers are used for drive wheels. They are configured for ‚Äúreverse displacement‚Äù (inversion of direction), and provide regulated 5 V output for the microcontroller. PWM outputs from MCU (via MCPWM) control motor speed and direction.

---

### IMU: TransducerM TM151 (9-axis AHRS)  
| Parameter | Specification |
|-----------|-------------|
| Device | TM151 IMU ‚Äì 9-axis (accelerometer + gyroscope + magnetometer) attitude and heading reference system. :contentReference[oaicite:17]{index=17} |
| Output | Roll, pitch, yaw, quaternions; raw accelerations/gyro/magnetometer. :contentReference[oaicite:18]{index=18} |
| Typical gyroscope range | ¬±1000¬∞/s (typical) for this model. :contentReference[oaicite:19]{index=19} |
| Output update rate | Up to ~400 Hz (configurable) for orientation output. :contentReference[oaicite:20]{index=20} |
| Power & interface | Compatible with 3.3/5 V, interface UART (TTL) or USB-C (VCP). :contentReference[oaicite:21]{index=21} |
| Yaw drift | Approx. ~3¬∞ every 25 minutes under flat conditions (yaw drift spec). :contentReference[oaicite:22]{index=22} |

**Usage in this project**: Intended for sensor fusion (together with encoders and lidar) to estimate robot orientation and velocity. At present, the sensor-fusion module remains in a preliminary state (many functions inactive), but the IMU driver is available.

---

### Key Modules & Functionality  
- **Platform Abstraction**: `platform.c` provides a single point for hardware interface changes (e.g., migrating to a different microcontroller).  
- **Sensor Drivers**: Modular drivers allow easy adaptation of new sensors or reconfiguration.  
- **Control Loop**: The PID module computes wheel velocities based on encoder feedback and commands the MCPWM module to actuate the ESCs.  
- **Task Scheduling**: Using FreeRTOS, tasks are defined for each sensor and control loop (e.g., `vTaskEncoder()`, `vTaskIMU()`, `vTaskControl()`, etc.). Note: some tasks (e.g., LiDAR, WiFi) are currently disabled because they are non-functional in this iteration.  
- **Motion Kinematics**: `mov_calculation.c` performs conversion from linear/circular motion commands to per-wheel angular velocities, based on robot geometry.  
- **Calibration Routines**: For initial setup of encoders and ESCs, calibration tasks are supplied to save configuration to non-volatile memory.
